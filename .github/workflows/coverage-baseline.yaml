name: Update Coverage Baseline

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-baseline:
    name: Update Coverage Baseline
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push to gh-pages
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Run tests with coverage
        env:
          # MongoDB configuration
          MONGODB_URI: mongodb://localhost:27017
          MONGODB_DATABASE: rmi_test
          MONGODB_CITIZEN_COLLECTION: citizens
          MONGODB_SELF_DECLARED_COLLECTION: self_declared
          MONGODB_PHONE_MAPPING_COLLECTION: phone_mapping
          MONGODB_OPT_IN_HISTORY_COLLECTION: opt_in_history
          MONGODB_AUDIT_LOG_COLLECTION: audit_logs
          MONGODB_BETA_GROUPS_COLLECTION: beta_groups
          MONGODB_WHATSAPP_MEMORY_COLLECTION: whatsapp_memory
          MONGODB_AVATARS_COLLECTION: avatars
          MONGODB_MAINTENANCE_REQUEST_COLLECTION: maintenance_requests
          MONGODB_LEGAL_ENTITY_COLLECTION: legal_entities
          MONGODB_CHAT_MEMORY_COLLECTION: chat_memory
          MONGODB_CNAE_COLLECTION: cnae
          MONGODB_DEPARTMENT_COLLECTION: departments
          MONGODB_PET_COLLECTION: pets
          MONGODB_PETS_SELF_REGISTERED_COLLECTION: pets_self_registered
          # Redis configuration
          REDIS_ADDR: localhost:6379
          REDIS_PASSWORD: ""
          REDIS_DB: 0
          REDIS_CLUSTER_ENABLED: "false"
          # API configuration
          JWT_ISSUER_URL: http://localhost:8080
          PORT: "8080"
          # Feature flags
          CF_LOOKUP_ENABLED: "false"
          WHATSAPP_ENABLED: "false"
          # MCP configuration
          MCP_SERVER_URL: http://localhost:8000
          MCP_AUTH_TOKEN: test-token
          # WhatsApp configuration
          WHATSAPP_API_BASE_URL: http://localhost:9000
          WHATSAPP_API_USERNAME: test
          WHATSAPP_API_PASSWORD: test
          WHATSAPP_CAMPAIGN_NAME: test
          WHATSAPP_COST_CENTER_ID: "1"
          WHATSAPP_HSM_ID: "1"
        run: go test -coverprofile=coverage.out -timeout=5m ./...

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(./scripts/get-coverage.sh coverage.out)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-dir
        continue-on-error: true  # First run won't have gh-pages yet

      - name: Create gh-pages branch if it doesn't exist
        run: |
          if [ ! -d "gh-pages-dir/.git" ]; then
            echo "Creating gh-pages branch..."
            mkdir -p gh-pages-dir
            cd gh-pages-dir
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b gh-pages
            echo "# Coverage Reports" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch"
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push -u origin gh-pages
          fi

      - name: Update coverage baseline
        run: |
          cd gh-pages-dir
          echo "${{ steps.coverage.outputs.coverage }}" > coverage-baseline.txt

          # Create a coverage badge JSON (for future use)
          COVERAGE="${{ steps.coverage.outputs.coverage }}"
          COLOR="red"
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then COLOR="brightgreen"; fi
          if (( $(echo "$COVERAGE >= 60 && $COVERAGE < 80" | bc -l) )); then COLOR="yellow"; fi
          if (( $(echo "$COVERAGE >= 40 && $COVERAGE < 60" | bc -l) )); then COLOR="orange"; fi

          cat > coverage-badge.json <<EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${COVERAGE}%",
            "color": "${COLOR}"
          }
          EOF

          # Update timestamp
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > coverage-updated.txt
          echo "Commit: ${{ github.sha }}" >> coverage-updated.txt

      - name: Commit and push baseline
        run: |
          cd gh-pages-dir
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage-baseline.txt coverage-badge.json coverage-updated.txt
          git commit -m "Update coverage baseline to ${{ steps.coverage.outputs.coverage }}%" || exit 0
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:gh-pages

      - name: Generate coverage report
        run: |
          echo "## ðŸ“Š Coverage Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage**: ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Baseline updated in gh-pages branch." >> $GITHUB_STEP_SUMMARY
