name: Release and Deploy

on:
  release:
    types: [published]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Install swag
        run: |
          mkdir -p bin
          GOBIN="$PWD/bin" go install github.com/swaggo/swag/cmd/swag@latest
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Generate Swagger documentation
        run: swag init -g cmd/api/main.go

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Extract release version
        id: version
        run: |
          VERSION=${{ github.ref_name }}
          VERSION_NO_V=${VERSION#v}
          COMMIT_HASH=$(git rev-parse --short HEAD)

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NO_V=$VERSION_NO_V" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/app-rmi" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --build-arg VERSION=$COMMIT_HASH \
            --tag $IMAGE_NAME:$VERSION \
            --tag $IMAGE_NAME:$VERSION_NO_V \
            --tag $IMAGE_NAME:latest-release \
            --push .

      - name: Get image digest
        id: digest
        run: |
          DIGEST=$(docker buildx imagetools inspect $IMAGE_NAME:$VERSION --format '{{.Manifest.Digest}}')
          echo "DIGEST=$DIGEST" >> $GITHUB_ENV
          echo "Image digest: $DIGEST"

      - name: Update production Rollout image
        run: |
          # Update the image tag with digest for immutable deployments
          sed -i "s|image: ghcr.io/prefeitura-rio/app-rmi:.*  # Updated by release workflow|image: ghcr.io/prefeitura-rio/app-rmi:$VERSION@$DIGEST  # Updated by release workflow|g" k8s/prod/resources.yaml

          # Configure git
          git config user.name 'GitHub Actions'
          git config user.email 'github-actions@github.com'

          # Commit and push
          git add k8s/prod/resources.yaml
          git commit -m "chore: update prod image to $VERSION@${DIGEST:0:12}"
          git push

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: gcloud components install gke-gcloud-auth-plugin

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: latest

      - name: Configure kubectl for GKE
        run: gcloud container clusters get-credentials application --zone=us-central1 --project="${{ vars.GCP_PROJECT_ID }}"

      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting 30s for ArgoCD to detect and sync changes..."
          sleep 30

      - name: Monitor Rollout
        timeout-minutes: 45
        run: |
          echo "Monitoring rollout progress..."

          while true; do
            PHASE=$(kubectl get rollout rmi -n rmi -o jsonpath='{.status.phase}')
            MESSAGE=$(kubectl get rollout rmi -n rmi -o jsonpath='{.status.message}')

            echo "Rollout phase: $PHASE"
            echo "Message: $MESSAGE"

            # Check if rollout completed successfully
            if [ "$PHASE" = "Healthy" ]; then
              echo "âœ… Rollout completed successfully!"
              exit 0
            fi

            # Check if rollout was aborted or degraded
            if [ "$PHASE" = "Degraded" ]; then
              echo "âŒ Rollout failed - status is Degraded"
              echo "Message: $MESSAGE"
              kubectl get rollout rmi -n rmi -o yaml
              exit 1
            fi

            if [ "$PHASE" = "Aborted" ]; then
              echo "âŒ Rollout was aborted (likely due to failed analysis)"
              echo "Message: $MESSAGE"

              # Get analysis run details
              echo "Analysis Run Details:"
              kubectl get analysisrun -n rmi -l rollout-pod-template-hash=$(kubectl get rollout rmi -n rmi -o jsonpath='{.status.canary.stableRS}') --sort-by=.metadata.creationTimestamp -o yaml || true

              exit 1
            fi

            # Show current status
            kubectl get rollout rmi -n rmi

            echo "Waiting 30s before next check..."
            sleep 30
          done

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Release Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: $COMMIT_HASH" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`$IMAGE_NAME:$VERSION@${DIGEST:0:12}...\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PHASE=$(kubectl get rollout rmi -n rmi -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
          echo "**Final Status**: $PHASE" >> $GITHUB_STEP_SUMMARY

          if [ "$PHASE" = "Healthy" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "The canary deployment completed successfully and is now serving 100% traffic." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "The rollout did not complete successfully. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
