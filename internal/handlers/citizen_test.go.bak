package handlers

import (
	"bytes"
	"encoding/json"
	"flag"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/gin-gonic/gin"
	"github.com/stretchr/testify/assert"
)

var cpfTest = "03561350712"

func init() {
	// Parse flags for CPF test value
	flag.StringVar(&cpfTest, "cpf", "03561350712", "CPF to use for testing")
}

func setupRouter() *gin.Engine {
	gin.SetMode(gin.TestMode)
	r := gin.New()
	r.GET("/v1/citizen/:cpf", GetCitizenData)
	r.GET("/v1/citizen/:cpf/wallet", GetCitizenWallet)
	r.GET("/v1/citizen/:cpf/maintenance-request", GetMaintenanceRequests)
	r.PUT("/v1/citizen/:cpf/address", UpdateSelfDeclaredAddress)
	r.PUT("/v1/citizen/:cpf/phone", UpdateSelfDeclaredPhone)
	r.PUT("/v1/citizen/:cpf/email", UpdateSelfDeclaredEmail)
	r.PUT("/v1/citizen/:cpf/ethnicity", UpdateSelfDeclaredRaca)
	r.GET("/v1/health", HealthCheck)
	r.GET("/v1/citizen/:cpf/firstlogin", GetFirstLogin)
	r.PUT("/v1/citizen/:cpf/firstlogin", UpdateFirstLogin)
	r.GET("/v1/citizen/:cpf/optin", GetOptIn)
	r.PUT("/v1/citizen/:cpf/optin", UpdateOptIn)
	return r
}

func TestGetCitizenData(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/v1/citizen/"+cpfTest, nil)
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusNotFound}, w.Code, "Expected 200 or 404")
}

func TestGetCitizenWallet(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/v1/citizen/"+cpfTest+"/wallet", nil)
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusNotFound}, w.Code, "Expected 200 or 404")
}

func TestGetMaintenanceRequests(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/v1/citizen/"+cpfTest+"/maintenance-request", nil)
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusNotFound}, w.Code, "Expected 200 or 404")
}

func TestUpdateSelfDeclaredAddress(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	body := map[string]interface{}{
		"Bairro":     "Centro",
		"CEP":        "20000000",
		"Estado":     "RJ",
		"Logradouro": "Rua Teste",
		"Municipio":  "Rio de Janeiro",
		"Numero":     "123",
	}
	jsonBody, _ := json.Marshal(body)
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/address", bytes.NewBuffer(jsonBody))
	req.Header.Set("Content-Type", "application/json")
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusConflict, http.StatusBadRequest}, w.Code, "Expected 200, 409, or 400")
}

func TestUpdateSelfDeclaredPhone(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	body := map[string]interface{}{
		"DDI":   "+55",
		"DDD":   "21",
		"Valor": "999999999",
	}
	jsonBody, _ := json.Marshal(body)
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/phone", bytes.NewBuffer(jsonBody))
	req.Header.Set("Content-Type", "application/json")
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusConflict, http.StatusBadRequest}, w.Code, "Expected 200, 409, or 400")
}

func TestUpdateSelfDeclaredEmail(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	body := map[string]interface{}{
		"Valor": "test@example.com",
	}
	jsonBody, _ := json.Marshal(body)
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/email", bytes.NewBuffer(jsonBody))
	req.Header.Set("Content-Type", "application/json")
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusConflict, http.StatusBadRequest}, w.Code, "Expected 200, 409, or 400")
}

func TestUpdateSelfDeclaredRaca(t *testing.T) {
	t.Logf("Testing with CPF: %s", cpfTest)
	r := setupRouter()
	w := httptest.NewRecorder()
	body := map[string]interface{}{
		"Valor": "branca",
	}
	jsonBody, _ := json.Marshal(body)
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/ethnicity", bytes.NewBuffer(jsonBody))
	req.Header.Set("Content-Type", "application/json")
	r.ServeHTTP(w, req)

	// Log the response for debugging
	t.Logf("Response status: %d", w.Code)
	if w.Body.Len() > 0 {
		t.Logf("Response body: %s", w.Body.String())
	}

	assert.Contains(t, []int{http.StatusOK, http.StatusConflict, http.StatusBadRequest}, w.Code, "Expected 200, 409, or 400")
}

func TestHealthCheck(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/v1/health", nil)
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusServiceUnavailable}, w.Code, "Expected 200 or 503")
}

func TestGetFirstLogin(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/v1/citizen/"+cpfTest+"/firstlogin", nil)
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")
}

func TestUpdateFirstLogin(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/firstlogin", nil)
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")
}

func TestGetOptIn(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/v1/citizen/"+cpfTest+"/optin", nil)
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")
}

func TestUpdateOptIn(t *testing.T) {
	r := setupRouter()
	w := httptest.NewRecorder()
	body := map[string]interface{}{
		"OptIn": true,
	}
	jsonBody, _ := json.Marshal(body)
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/optin", bytes.NewBuffer(jsonBody))
	req.Header.Set("Content-Type", "application/json")
	r.ServeHTTP(w, req)
	assert.Contains(t, []int{http.StatusOK, http.StatusBadRequest}, w.Code, "Expected 200 or 400")
}

// Edge case tests

func TestGetCitizenData_InvalidCPF(t *testing.T) {
	r := setupRouter()

	tests := []struct {
		name         string
		cpf          string
		expectedCode int
	}{
		{"empty CPF", "", http.StatusNotFound},        // Empty CPF = route not found
		{"short CPF", "123", http.StatusBadRequest},   // Invalid format
		{"letters in CPF", "abcdefghijk", http.StatusBadRequest},
		{"special characters", "123@456#789", http.StatusBadRequest},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			req, _ := http.NewRequest("GET", "/v1/citizen/"+tt.cpf, nil)
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, tt.expectedCode, w.Code, "Expected %d for %s", tt.expectedCode, tt.name)
		})
	}
}

func TestUpdateSelfDeclaredAddress_MalformedJSON(t *testing.T) {
	r := setupRouter()

	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/address", bytes.NewBufferString("invalid json"))
	req.Header.Set("Content-Type", "application/json")
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for malformed JSON")
}

func TestUpdateSelfDeclaredAddress_MissingFields(t *testing.T) {
	r := setupRouter()

	tests := []struct {
		name string
		body map[string]interface{}
	}{
		{"missing CEP", map[string]interface{}{
			"Bairro":     "Centro",
			"Estado":     "RJ",
			"Logradouro": "Rua Teste",
			"Municipio":  "Rio de Janeiro",
			"Numero":     "123",
		}},
		{"missing Estado", map[string]interface{}{
			"Bairro":     "Centro",
			"CEP":        "20000000",
			"Logradouro": "Rua Teste",
			"Municipio":  "Rio de Janeiro",
			"Numero":     "123",
		}},
		{"missing Logradouro", map[string]interface{}{
			"Bairro":    "Centro",
			"CEP":       "20000000",
			"Estado":    "RJ",
			"Municipio": "Rio de Janeiro",
			"Numero":    "123",
		}},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/address", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for missing fields")
		})
	}
}

func TestUpdateSelfDeclaredPhone_MalformedJSON(t *testing.T) {
	r := setupRouter()

	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/phone", bytes.NewBufferString("invalid json"))
	req.Header.Set("Content-Type", "application/json")
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for malformed JSON")
}

func TestUpdateSelfDeclaredPhone_MissingFields(t *testing.T) {
	r := setupRouter()

	tests := []struct {
		name string
		body map[string]interface{}
	}{
		{"missing DDI", map[string]interface{}{
			"DDD":   "21",
			"Valor": "999999999",
		}},
		{"missing DDD", map[string]interface{}{
			"DDI":   "+55",
			"Valor": "999999999",
		}},
		{"missing Valor", map[string]interface{}{
			"DDI": "+55",
			"DDD": "21",
		}},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/phone", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for missing fields")
		})
	}
}

func TestUpdateSelfDeclaredEmail_MalformedJSON(t *testing.T) {
	r := setupRouter()

	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/email", bytes.NewBufferString("invalid json"))
	req.Header.Set("Content-Type", "application/json")
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for malformed JSON")
}

func TestUpdateSelfDeclaredEmail_InvalidEmail(t *testing.T) {
	r := setupRouter()

	tests := []struct {
		name  string
		email string
	}{
		{"missing @", "testexample.com"},
		{"missing domain", "test@"},
		{"missing local part", "@example.com"},
		{"empty email", ""},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			body := map[string]interface{}{
				"Valor": tt.email,
			}
			jsonBody, _ := json.Marshal(body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/email", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for invalid email")
		})
	}
}

func TestUpdateSelfDeclaredRaca_MalformedJSON(t *testing.T) {
	r := setupRouter()

	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/ethnicity", bytes.NewBufferString("invalid json"))
	req.Header.Set("Content-Type", "application/json")
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for malformed JSON")
}

func TestUpdateSelfDeclaredRaca_InvalidValues(t *testing.T) {
	r := setupRouter()

	tests := []struct {
		name  string
		valor string
	}{
		{"empty value", ""},
		{"invalid race", "invalid_race"},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			body := map[string]interface{}{
				"Valor": tt.valor,
			}
			jsonBody, _ := json.Marshal(body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/ethnicity", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for invalid race value")
		})
	}
}

func TestUpdateOptIn_MalformedJSON(t *testing.T) {
	r := setupRouter()

	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/optin", bytes.NewBufferString("invalid json"))
	req.Header.Set("Content-Type", "application/json")
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for malformed JSON")
}

func TestUpdateOptIn_MissingOptInField(t *testing.T) {
	r := setupRouter()

	body := map[string]interface{}{}
	jsonBody, _ := json.Marshal(body)
	req, _ := http.NewRequest("PUT", "/v1/citizen/"+cpfTest+"/optin", bytes.NewBuffer(jsonBody))
	req.Header.Set("Content-Type", "application/json")
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)
	assert.Equal(t, http.StatusBadRequest, w.Code, "Expected 400 for missing OptIn field")
}

// Test helper functions and options functions

func TestGetEthnicityOptions(t *testing.T) {
	r := gin.New()
	r.GET("/v1/ethnicity-options", GetEthnicityOptions)

	req, _ := http.NewRequest("GET", "/v1/ethnicity-options", nil)
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)

	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")

	var response []string
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err, "Response should be valid JSON array")
	assert.Greater(t, len(response), 0, "Response should contain options")
	assert.Contains(t, response, "branca", "Options should contain 'branca'")
}

func TestGetGenderOptions(t *testing.T) {
	r := gin.New()
	r.GET("/v1/gender-options", GetGenderOptions)

	req, _ := http.NewRequest("GET", "/v1/gender-options", nil)
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)

	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")

	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err, "Response should be valid JSON")
	assert.Contains(t, response, "options", "Response should contain options field")
}

func TestGetFamilyIncomeOptions(t *testing.T) {
	r := gin.New()
	r.GET("/v1/family-income-options", GetFamilyIncomeOptions)

	req, _ := http.NewRequest("GET", "/v1/family-income-options", nil)
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)

	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")

	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err, "Response should be valid JSON")
	assert.Contains(t, response, "options", "Response should contain options field")
}

func TestGetEducationOptions(t *testing.T) {
	r := gin.New()
	r.GET("/v1/education-options", GetEducationOptions)

	req, _ := http.NewRequest("GET", "/v1/education-options", nil)
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)

	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")

	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err, "Response should be valid JSON")
	assert.Contains(t, response, "options", "Response should contain options field")
}

func TestGetDisabilityOptions(t *testing.T) {
	r := gin.New()
	r.GET("/v1/disability-options", GetDisabilityOptions)

	req, _ := http.NewRequest("GET", "/v1/disability-options", nil)
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)

	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")

	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err, "Response should be valid JSON")
	assert.Contains(t, response, "options", "Response should contain options field")
}

func TestMetricsHandler(t *testing.T) {
	r := gin.New()
	r.GET("/metrics", MetricsHandler)

	req, _ := http.NewRequest("GET", "/metrics", nil)
	w := httptest.NewRecorder()
	r.ServeHTTP(w, req)

	assert.Equal(t, http.StatusOK, w.Code, "Expected 200 OK")
	// Prometheus metrics should be in text format
	assert.Contains(t, w.Header().Get("Content-Type"), "text/plain", "Should return Prometheus text format")
}

// Test new self-declared update endpoints

func TestUpdateSelfDeclaredGenero(t *testing.T) {
	r := gin.New()
	r.PUT("/v1/citizen/:cpf/gender", UpdateSelfDeclaredGenero)

	tests := []struct {
		name           string
		cpf            string
		body           map[string]interface{}
		expectedStatus int
	}{
		{
			name: "valid gender update",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "Masculino",
			},
			expectedStatus: http.StatusOK,
		},
		{
			name: "invalid CPF",
			cpf:  "invalid",
			body: map[string]interface{}{
				"Valor": "Masculino",
			},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name:           "missing valor",
			cpf:            cpfTest,
			body:           map[string]interface{}{},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name: "invalid gender value",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "InvalidGender",
			},
			expectedStatus: http.StatusBadRequest,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+tt.cpf+"/gender", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, tt.expectedStatus, w.Code)
		})
	}
}

func TestUpdateSelfDeclaredRendaFamiliar(t *testing.T) {
	r := gin.New()
	r.PUT("/v1/citizen/:cpf/family-income", UpdateSelfDeclaredRendaFamiliar)

	tests := []struct {
		name           string
		cpf            string
		body           map[string]interface{}
		expectedStatus int
	}{
		{
			name: "valid family income update",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "Até 1 salário mínimo",
			},
			expectedStatus: http.StatusOK,
		},
		{
			name: "invalid CPF",
			cpf:  "invalid",
			body: map[string]interface{}{
				"Valor": "Até 1 salário mínimo",
			},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name:           "missing valor",
			cpf:            cpfTest,
			body:           map[string]interface{}{},
			expectedStatus: http.StatusBadRequest,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+tt.cpf+"/family-income", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, tt.expectedStatus, w.Code)
		})
	}
}

func TestUpdateSelfDeclaredEscolaridade(t *testing.T) {
	r := gin.New()
	r.PUT("/v1/citizen/:cpf/education", UpdateSelfDeclaredEscolaridade)

	tests := []struct {
		name           string
		cpf            string
		body           map[string]interface{}
		expectedStatus int
	}{
		{
			name: "valid education update",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "Ensino médio completo",
			},
			expectedStatus: http.StatusOK,
		},
		{
			name: "invalid CPF",
			cpf:  "invalid",
			body: map[string]interface{}{
				"Valor": "Ensino médio completo",
			},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name:           "missing valor",
			cpf:            cpfTest,
			body:           map[string]interface{}{},
			expectedStatus: http.StatusBadRequest,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+tt.cpf+"/education", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, tt.expectedStatus, w.Code)
		})
	}
}

func TestUpdateSelfDeclaredDeficiencia(t *testing.T) {
	r := gin.New()
	r.PUT("/v1/citizen/:cpf/disability", UpdateSelfDeclaredDeficiencia)

	tests := []struct {
		name           string
		cpf            string
		body           map[string]interface{}
		expectedStatus int
	}{
		{
			name: "valid disability update",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "Sim",
			},
			expectedStatus: http.StatusOK,
		},
		{
			name: "invalid CPF",
			cpf:  "invalid",
			body: map[string]interface{}{
				"Valor": "Sim",
			},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name:           "missing valor",
			cpf:            cpfTest,
			body:           map[string]interface{}{},
			expectedStatus: http.StatusBadRequest,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+tt.cpf+"/disability", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, tt.expectedStatus, w.Code)
		})
	}
}

func TestUpdateSelfDeclaredNomeExibicao(t *testing.T) {
	r := gin.New()
	r.PUT("/v1/citizen/:cpf/display-name", UpdateSelfDeclaredNomeExibicao)

	tests := []struct {
		name           string
		cpf            string
		body           map[string]interface{}
		expectedStatus int
	}{
		{
			name: "valid display name update",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "João da Silva",
			},
			expectedStatus: http.StatusOK,
		},
		{
			name: "invalid CPF",
			cpf:  "invalid",
			body: map[string]interface{}{
				"Valor": "João da Silva",
			},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name:           "missing valor",
			cpf:            cpfTest,
			body:           map[string]interface{}{},
			expectedStatus: http.StatusBadRequest,
		},
		{
			name: "empty display name",
			cpf:  cpfTest,
			body: map[string]interface{}{
				"Valor": "",
			},
			expectedStatus: http.StatusBadRequest,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			jsonBody, _ := json.Marshal(tt.body)
			req, _ := http.NewRequest("PUT", "/v1/citizen/"+tt.cpf+"/display-name", bytes.NewBuffer(jsonBody))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()
			r.ServeHTTP(w, req)
			assert.Equal(t, tt.expectedStatus, w.Code)
		})
	}
}
